<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8">
    <title>Forum Webpage</title>

    <style>
        @import url(forumStyles.css);
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const header = document.querySelector('.fixed-header');
            const postFormContainer = document.querySelector('.post-form-container');

            // Function to add or remove the 'fixed' class based on scroll position
            function toggleFixedHeader() {
                if (window.scrollY > header.offsetTop) {
                    header.classList.add('fixed');
                } else {
                    header.classList.remove('fixed');
                }
            }

            // Function to toggle visibility of post form based on user login status
            function togglePostFormVisibility(isUserLoggedIn) {
                postFormContainer.style.display = isUserLoggedIn ? 'block' : 'none';
            }

            // Listen for the scroll event and call the toggleFixedHeader function
            window.addEventListener('scroll', toggleFixedHeader);

            // Fetch user login status and toggle post form visibility
            fetch('/api/username')
                .then(response => response.json())
                .then(data => {
                    if (data.username) {
                        togglePostFormVisibility(true);

                        const leftButton = document.getElementById('leftButton');
                        const rightButton = document.getElementById('rightButton');
                        leftButton.textContent = 'Account';
                        leftButton.onclick = function () { window.location.href = '/account'; };
                        rightButton.textContent = `Sign Out of ${data.username}`;
                        rightButton.onclick = function () { window.location.href = '/signout'; };
                    } else {
                        togglePostFormVisibility(false);

                        const leftButton = document.getElementById('leftButton');
                        const rightButton = document.getElementById('rightButton');
                        leftButton.textContent = 'Sign Up';
                        leftButton.onclick = function () { window.location.href = '/signup'; };
                        rightButton.textContent = 'Login';
                        rightButton.onclick = function () { window.location.href = '/login'; };
                    }
                })
                .catch(error => {
                    console.error("Error fetching username:", error);
                    togglePostFormVisibility(false);

                    const leftButton = document.getElementById('leftButton');
                    const rightButton = document.getElementById('rightButton');
                    leftButton.textContent = 'Sign Up';
                    leftButton.onclick = function () { window.location.href = '/signup'; };
                    rightButton.textContent = 'Login';
                    rightButton.onclick = function () { window.location.href = '/login'; };
                });
        });
    </script>
</head>

<body>
    <header class="fixed-header">
        <!-- nav and ul elements used for formatting organization -->
        <nav>
            <div class="link-buttons mt-3">
                <a href="index.html" class="btn btn-primary mr-2 mb-2">Home</a>
                <a href="forum.html" class="btn btn-primary mr-2 mb-2">Forum</a>
                <a href="videopage.html" class="btn btn-primary mr-2 mb-2">Video Library</a>
                <a href="dashboard.html" class="btn btn-primary mr-2 mb-2">Progress Dashboard</a>
                <a href="article_library.html" class="btn btn-primary mr-2 mb-2">Article Library</a>
                <a href="DailyInteractive/dailyInteractive.html" class="btn btn-primary mr-2 mb-2">Daily Interactive</a>
            </div>
        </nav>
    </header>

    <!-- Login button -->
    <div class="user-button-container" style="text-align: right; padding-right: 20px; padding-top: 80px;">
        <button id="leftButton" class="btn btn-primary btn-lg">Sign Up</button>
        <button id="rightButton" class="btn btn-secondary btn-lg">Login</button>
    </div>

    <h1 class="logo-container"><img src="MeditationLogo.PNG" alt="logo"></h1>

    <h1>Meditation+ Forum</h1>

    <div class="post-form-container">
        <h2>Create a New Post</h2>
        <form id="postForm">
            <label for="postTitle">Title:</label>
            <input type="text" id="postTitle" name="postTitle" required>
    
            <label for="postContent">Content:</label>
            <textarea id="postContent" name="postContent" required></textarea>
    
            <button type="submit">Post</button>
        </form>
    </div>

    <!-- Section for displaying forum posts -->
    <h2>Forum Posts</h2>

    <section id="forum-posts">

    </section>

    <footer>
        <p><small>This page and all properties owned by Meditation+&copy;</small></p>
    </footer>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            //Functionality for login and signup
            const leftButton = document.getElementById('leftButton');
            const rightButton = document.getElementById('rightButton');

            fetch('/api/username').then(response => response.json()).then(data => {
                if (data.username) {
                    leftButton.textContent = 'Account';
                    leftButton.onclick = function () { window.location.href = '/account'; };
                    // Dynamically use the username in the 'Sign Out' button text
                    rightButton.textContent = `Sign Out of ${data.username}`;
                    rightButton.onclick = function () { window.location.href = '/signout'; };
                } else {
                    leftButton.textContent = 'Sign Up';
                    leftButton.onclick = function () { window.location.href = '/signup'; };
                    rightButton.textContent = 'Login';
                    rightButton.onclick = function () { window.location.href = '/login'; };
                }
            }).catch(error => {
                console.error("Error fetching username:", error);
                leftButton.textContent = 'Sign Up';
                leftButton.onclick = function () { window.location.href = '/signup'; };
                rightButton.textContent = 'Login';
                rightButton.onclick = function () { window.location.href = '/login'; };
            });
        });

        // Functionality for listening for user interaction
        const postForm = document.getElementById('postForm');
        postForm.addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent the default form submission

            const postTitle = document.getElementById('postTitle').value;
            const postContent = document.getElementById('postContent').value;

            // Call a function to handle the creation of a new post
            createNewPost(postTitle, postContent);
        });

        // Function to generate a unique identifier
        function generateUniqueId() {
            return Math.random().toString(36).substring(2, 10);
        }

        // Function to get all posts from server
        async function getAllPosts() {
            // Retrieve all posts from KV
            const allKeys = await COOLFROG_FORUM.list();
            const allPosts = [];

            for (const key of allKeys.keys) {
                const post = await COOLFROG_FORUM.get(key.name, { type: 'json' });
                allPosts.push(post);
            }

            return allPosts;
        }

        // Function to create a new page
        async function createNewPage(title, content) {
            try {

                // Get information to send to server
                const postContent = [title, content];
                const postId = generateUniqueId();

                // Send information to server
                await COOLFROG_FORUM.put(postId, JSON.stringify(postContent));

                // Create a link to the new page and append it to the 'forum-posts' section
                const forumPostsSection = document.getElementById('forum-posts');
                const newPageLink = document.createElement('a');
                newPageLink.href = `/forum/${postId}`; // Update the path based on your URL structure
                newPageLink.textContent = title;
                const newPageElement = document.createElement('div');
                newPageElement.appendChild(newPageLink);
                forumPostsSection.appendChild(newPageElement);
            } catch (error) {
                console.error('Error creating a new page:', error);
            }
        }
    </script>
</body>

</html>
